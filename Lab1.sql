create database Library;
use Library;

CREATE TABLE PUBLISHER(
    NAME VARCHAR(18) PRIMARY KEY,
    ADDRESS VARCHAR(10),
    PHONE VARCHAR(10)
);
CREATE TABLE BOOK(
    BOOK_ID INTEGER PRIMARY KEY,
    TITLE VARCHAR(20),
    PUBLISHER_NAME VARCHAR(20),
    PUB_YEAR INT(4),
    FOREIGN KEY(PUBLISHER_NAME) REFERENCES PUBLISHER(NAME) ON DELETE CASCADE
);
CREATE TABLE BOOK_AUTHORS(
    BOOK_ID INTEGER,
    AUTHOR_NAME VARCHAR(20),
    PRIMARY KEY(BOOK_ID),
    FOREIGN KEY(BOOK_ID) REFERENCES BOOK(BOOK_ID) ON DELETE CASCADE
);
CREATE TABLE LIBRARY_PROGRAMME(
    PROGRAMME_ID INTEGER PRIMARY KEY,
    PROGRAMME_NAME VARCHAR(18),
    ADDRESS VARCHAR(15)
);
CREATE TABLE BOOK_COPIES(
    BOOK_ID INTEGER,
    PROGRAMME_ID INTEGER,
    NO_OF_COPIES INTEGER,
    FOREIGN KEY(BOOK_ID) REFERENCES BOOK(BOOK_ID) ON DELETE CASCADE,
    FOREIGN KEY(PROGRAMME_ID) REFERENCES LIBRARY_PROGRAMME(PROGRAMME_ID) ON DELETE CASCADE,
    PRIMARY KEY(BOOK_ID, PROGRAMME_ID)
);
CREATE TABLE BOOK_LENDING(
    BOOK_ID INTEGER,
    PROGRAMME_ID INTEGER,
    CARD_NO INTEGER,
    DATE_OUT DATE,
    DUE_DATE DATE,
    PRIMARY KEY(BOOK_ID, PROGRAMME_ID, CARD_NO),
    FOREIGN KEY(BOOK_ID) REFERENCES BOOK(BOOK_ID) ON DELETE CASCADE,
    FOREIGN KEY(PROGRAMME_ID) REFERENCES LIBRARY_PROGRAMME(PROGRAMME_ID) ON DELETE CASCADE
);

INSERT INTO PUBLISHER
VALUES ('PEARSON', 'BANGALORE', '9875462530'),
    ('MCGRAW', 'NEWDELHI', '7845691234'),
    ('SAPNA', 'BANGALORE', '7845963210');
INSERT INTO BOOK
VALUES (1111, 'SE', 'PEARSON', 2005),
    (2222, 'DBMS', 'MCGRAW', 2004),
    (3333, 'ANOTOMY', 'PEARSON', 2010),
    (4444, 'ENCYCLOPEDIA', 'SAPNA', 2010);
INSERT INTO BOOK_AUTHORS
VALUES (1111, 'SOMMERVILLE'),
    (2222, 'NAVATHE'),
    (3333, 'HENRY GRAY'),
    (4444, 'THOMAS');
INSERT INTO LIBRARY_PROGRAMME
VALUES (11, 'CENTRAL TECHNICAL', 'MG ROAD'),
    (22, 'MEDICAL', 'BH ROAD'),
    (33, 'CHILDREN', 'SS PURAM'),
    (44, 'SECRETARIAT', 'SIRAGATE'),
    (55, 'GENERAL', 'JAYANAGAR');
INSERT INTO BOOK_COPIES
VALUES (1111, 11, 5),
    (3333, 22, 6),
    (4444, 33, 10),
    (2222, 11, 12),
    (4444, 55, 3);
INSERT INTO BOOK_LENDING
VALUES (2222, 11, 1, '2017-01-10', '2017-08-20'),
    (3333, 22, 2, '2017-07-09', '2017-08-12'),
    (4444, 55, 1, '2017-04-11', '2017-08-09'),
    (2222, 11, 5, '2017-08-09', '2017-08-19'),
    (4444, 33, 1, '2017-06-10', '2017-08-15'),
    (1111, 11, 1, '2017-05-12', '2017-06-10'),
    (3333, 22, 1, '2017-07-10', '2017-07-15');

/* 1) Retrieve details of all books in the library â€“ id, title, name of publisher, authors, number of copies in each PROGRAMME, etc.*/
SELECT PROGRAMME_NAME,
    B.BOOK_ID,
    TITLE,
    PUBLISHER_NAME,
    AUTHOR_NAME,
    NO_OF_COPIES
FROM BOOK B,
    BOOK_AUTHORS BA,
    BOOK_COPIES BC,
    LIBRARY_PROGRAMME LB
WHERE B.BOOK_ID = BA.BOOK_ID
    AND BA.BOOK_ID = BC.BOOK_ID
    AND BC.PROGRAMME_ID = LB.PROGRAMME_ID;

/* 2) Get the particulars of borrowers who have borrowed more than 3 books, but from Jan 2017 to Jun 2017. */
SELECT CARD_NO
FROM BOOK_LENDING
WHERE DATE_OUT BETWEEN '2017-01-01' AND '2017-06-30'
GROUP BY CARD_NO
HAVING COUNT(*) > 3;

/* 3) Delete a book in BOOK table. Update the contents of other tables to reflect this data manipulation operation. */
DELETE FROM BOOK
WHERE BOOK_ID = '3333';
SELECT *
FROM BOOK;

/* 4) Partition the BOOK table based on year of publication. Demonstrate its working with a simple query. */
CREATE VIEW V_PUBLICATION AS
SELECT PUB_YEAR, BOOK_ID, TITLE
FROM BOOK
GROUP BY PUB_YEAR, BOOK_ID
ORDER BY PUB_YEAR, BOOK_ID;
SELECT *
FROM V_PUBLICATION;

/* 5) Create a view of all books and its number of copies that are currently available in the Library. */
CREATE VIEW BOOKS_AVAILABLE AS
SELECT B.BOOK_ID,
    B.TITLE,
    C.NO_OF_COPIES
FROM LIBRARY_PROGRAMME L,
    BOOK B,
    BOOK_COPIES C
WHERE B.BOOK_ID = C.BOOK_ID
    AND L.PROGRAMME_ID = C.PROGRAMME_ID;
SELECT *
FROM BOOKS_AVAILABLE;

drop database Library;